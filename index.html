<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Attendance Form</title>

<!-- MSAL -->
<script src="https://alcdn.msauth.net/browser/2.37.0/js/msal-browser.min.js"></script>

<style>
:root{
  --bg:#f5f7fb;
  --card:#ffffff;
  --border:#e5edf5;
  --text:#0f172a;
  --muted:#64748b;
  --primary:#0d6efd;
}

html,body{
  height:100%;
  margin:0;
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;
  background: var(--bg);
  color: var(--text);
}

.page-wrap{
  min-height:100%;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:24px;
}

.card{
  width:460px;
  background:var(--card);
  padding:32px;
  border-radius:10px;
  box-shadow:0 10px 24px rgba(15,23,42,0.06);
}

h1{
  text-align:center;
  margin:0 0 28px;
  font-size:28px;
  font-weight:700;
}

label{
  display:block;
  font-size:14px;
  font-weight:500;
  color:#334155;
  margin-bottom:6px;
}

.required{
  color:#dc2626;
  margin-right:4px;
}

select,
input[type="file"]{
  width:100%;
  height:44px;
  padding:10px 12px;
  font-size:14px;
  border-radius:8px;
  border:1px solid var(--border);
  background:#fff;
  margin-bottom:18px;
  box-sizing:border-box;
}

select:focus,
input[type="file"]:focus{
  outline:none;
  border-color:var(--primary);
}

button{
  display:block;
  margin:10px auto 0;
  padding:10px 26px;
  background:var(--primary);
  color:#fff;
  border:none;
  border-radius:8px;
  font-size:15px;
  font-weight:600;
  cursor:pointer;
}

button:hover{
  background:#0b5ed7;
}

.note{
  margin-top:20px;
  font-size:13px;
  color:var(--muted);
  text-align:center;
  line-height:1.5;
}

.status{
  margin-top:12px;
  font-size:13px;
  color:#15803d;
  text-align:center;
}

@media (max-width:520px){
  .card{
    width:100%;
    padding:24px;
  }
}

</style>
</head>

<body>
  <div id="loginScreen" class="page-wrap">
  <div class="card" style="text-align:center">
    <h1>Attendance System</h1>
    <p style="color:#64748b;margin-bottom:20px">
      Sign in with Microsoft 365
    </p>
    <button onclick="login()">Sign in with Microsoft 365</button>
  </div>
</div>
<div class="page-wrap" id="formScreen" style="display:none">
  <div class="card">
    <h1>Attendance Form</h1>

    <label><span class="required">*</span> Email Address</label>
    <select id="emailSelect">
      <option value=""> Select email </option>
    </select>

    <label>Emp Code</label>
    <select id="empSelect">
      <option value=""> Select Emp Code </option>
    </select>

    <label><span class="required">*</span> Entry Type</label>
    <select id="entryType">
      <option value="Check-In">Check-In</option>
      <option value="Check-Out">Check-Out</option>
    </select>

    <label><span class="required">*</span> Work Shift</label>
    <select id="workShift">
      <option value="General">General</option>
      </select>

    <label><span class="required">*</span> CheckIn/CheckOut Location</label>
    <select id="location">
       <option value="IN Office">IN Office</option>
      <option value="OUT Side">OUT Side</option>
      <option value="WFH">WFH</option>
    </select>

   <button id="submitBtn" onclick="submitAttendance()">Submit</button>

    <div class="status" id="status"></div>

    <div class="note">
      Note: browser will request permission to access your location.
      This page must be served over HTTPS for geolocation to work.
    </div>
  </div>
</div>

<script>
/* ===== CONFIG (same pattern as dashboard) ===== */
const CLIENT_ID = "913e02e0-ebb9-4e17-b14c-14b9786442ce";
const TENANT_ID = "93846c24-8666-4033-8b6e-901877a2cf98";
const REDIRECT_URI = window.location.href;

const DRIVE_ID = "b!btaPqJ-5kU-kkE4KEoaxo8fltt6l6xpLs60U3YTj_EAxQMgJa8fsSLceYscvhxNo";
const FILE_ID  = "016GCLEJDXV63H3X7CPFDYYOHQUKHV47CG";

const SCOPES = ["Files.ReadWrite.All","Sites.Read.All","User.Read"];

const msalInstance = new msal.PublicClientApplication({
  auth:{ clientId:CLIENT_ID, authority:`https://login.microsoftonline.com/${TENANT_ID}`, redirectUri:REDIRECT_URI },
  cache:{ cacheLocation:"localStorage" }
});

let employees = [];

/* ===== AUTH ===== */
  async function login() {
  try {
    await msalInstance.loginPopup({
      scopes: SCOPES,
      prompt: "select_account"
    });

    // hide login, show form
    document.getElementById("loginScreen").style.display = "none";
    document.getElementById("formScreen").style.display = "flex";

    // load employees AFTER login
    await loadEmployees();
  } catch (e) {
    console.error(e);
    alert("Microsoft sign-in failed. Please try again.");
  }
}
async function checkExistingLogin() {
  const accounts = msalInstance.getAllAccounts();

  if (accounts.length > 0) {
    // User already logged in
    document.getElementById("loginScreen").style.display = "none";
    document.getElementById("formScreen").style.display = "flex";

    try {
      await loadEmployees();
    } catch (e) {
      console.error("Failed loading employees", e);
      alert("Session expired. Please sign in again.");
    }
  }
}

async function getToken() {
  const account = msalInstance.getAllAccounts()[0];
  if (!account) {
    throw new Error("User not logged in");
  }

  try {
    const res = await msalInstance.acquireTokenSilent({
      scopes: SCOPES,
      account
    });
    return res.accessToken;
  } catch (err) {
    const res = await msalInstance.acquireTokenPopup({
      scopes: SCOPES
    });
    return res.accessToken;
  }
}


/* ===== LOAD EMPLOYEES (NO TABLE) ===== */
  async function ensureLogin() {
  const accounts = msalInstance.getAllAccounts();
  if (accounts.length === 0) {
    await msalInstance.loginPopup({
      scopes: SCOPES,
      prompt: "select_account"
    });
  }
}

async function loadEmployees(){
  const token = await getToken();
  const url = `https://graph.microsoft.com/v1.0/drives/${DRIVE_ID}/items/${FILE_ID}/workbook/worksheets('Employees')/usedRange(valuesOnly=true)`;
  const r = await fetch(url,{headers:{Authorization:`Bearer ${token}`}});
  const j = await r.json();

  const headers = j.values[0];
  employees = j.values.slice(1).map(row=>({
    email: row[headers.indexOf("Microsoft Email ID")]?.toLowerCase(),
    empCode: row[headers.indexOf("Employee ID")],
    status: row[headers.indexOf("Status")]
  })).filter(e=>e.email && e.status==="Active");

  emailSelect.innerHTML = `<option value=""> Select email </option>`;
  empSelect.innerHTML   = `<option value=""> Select Emp Code </option>`;

  employees.forEach(e=>{
    emailSelect.innerHTML += `<option value="${e.email}">${e.email}</option>`;
    empSelect.innerHTML   += `<option value="${e.empCode}">${e.empCode}</option>`;
  });
}

emailSelect.onchange = ()=>{
  const e = employees.find(x=>x.email===emailSelect.value);
  if(e) empSelect.value = e.empCode;
};

/* ===== GEO ===== */
function getGeo(){
  return new Promise((res,rej)=>{
    navigator.geolocation.getCurrentPosition(p=>{
      res({lat:p.coords.latitude, lon:p.coords.longitude, acc:p.coords.accuracy});
    },rej,{enableHighAccuracy:true});
  });
}

/* ===== APPEND ROW (NO TABLE) ===== */
async function appendAttendance(values){
  const token = await getToken();
  const base = `https://graph.microsoft.com/v1.0/drives/${DRIVE_ID}/items/${FILE_ID}/workbook`;
  const used = await fetch(`${base}/worksheets('Attendance')/usedRange(valuesOnly=true)`,{
    headers:{Authorization:`Bearer ${token}`}
  }).then(r=>r.json());

  const nextRow = (used.values?.length || 1) + 1;
  const range = `A${nextRow}:J${nextRow}`;

  await fetch(`${base}/worksheets('Attendance')/range(address='${range}')`,{
    method:"PATCH",
    headers:{
      Authorization:`Bearer ${token}`,
      "Content-Type":"application/json"
    },
    body:JSON.stringify({values:[values]})
  });
}

/* ===== SUBMIT ===== */
async function submitAttendance(){
  const submitBtn = document.getElementById("submitBtn");
  submitBtn.disabled = true;
  submitBtn.innerText = "Submitting...";

  try {
    const locValue = document.getElementById("location").value;

    if(!emailSelect.value || !workShift.value || !locValue){
      alert("Please fill all required fields");
      submitBtn.disabled = false;
      submitBtn.innerText = "Submit";
      return;
    }

    const geo = await getGeo();
    const now = new Date();

    await appendAttendance([
      now.toISOString().split("T")[0],
      emailSelect.value,
      empSelect.value,
      entryType.value,
      workShift.value,
      locValue,
      geo.lat,
      geo.lon,
      geo.acc,
      now.toLocaleTimeString()
    ]);

    const statusEl = document.getElementById("status");
    statusEl.innerText = "Attendance submitted successfully ✔";
    statusEl.style.color = "#15803d";

    // Clear form
    emailSelect.value = "";
    empSelect.value = "";
    entryType.value = "Check-In";
    workShift.value = "";
    document.getElementById("location").value = "";

    // Keep button disabled after success
    submitBtn.innerText = "Submitted ✓";

  } catch (err) {
    console.error(err);
    alert("Error submitting attendance. Please try again.");

    // Re-enable button on error
    submitBtn.disabled = false;
    submitBtn.innerText = "Submit";
  }
}
  window.onload = () => {
  checkExistingLogin();
};

</script>
</body>
</html>

